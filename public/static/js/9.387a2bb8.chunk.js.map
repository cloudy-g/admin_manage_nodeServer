{"version":3,"sources":["pages/admin/ContentMain/Product/Update/index.jsx"],"names":["formItemLayout","labelCol","xs","span","sm","wrapperCol","tailFormItemLayout","offset","validateValues","data","sumData","find","v","title","Update","setSumData","setSource","useForm","form","history","useHistory","id","useParams","useState","options","setOptions","previewVisible","setPreviewVisible","previewImage","setPreviewImage","previewTitle","setPreviewTitle","fileList","setFileList","src","setSrc","updateItem","updateIndex","findIndex","pid","onFinish","values","a","console","log","res","tem","seller","price","type","updateProduct","fetchProduct","res1","map","key","error","nanoid","success","replace","uploadButton","style","marginTop","handlePreview","file","url","preview","getBase64","originFileObj","name","substring","lastIndexOf","useEffect","fetchCategory","target","dataMapToOptions","getOptions","setFieldsValue","uid","status","extra","className","onClick","goBack","scrollToFirstError","Item","label","rules","required","message","placeholder","valuePropName","action","listType","onPreview","onChange","response","split","shift","join","length","visible","footer","onCancel","alt","width","htmlType","Promise","resolve","reject","reader","FileReader","readAsDataURL","onload","result","onerror"],"mappings":"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","file":"static/js/9.387a2bb8.chunk.js","sourcesContent":["import React, { useState, useEffect } from 'react';\r\n\r\nimport { useHistory, useParams } from 'react-router-dom'\r\nimport {\r\n  Card, Form, Input, Cascader, message, Button, Upload, Modal\r\n} from 'antd';\r\nimport { ArrowLeftOutlined, PlusOutlined } from '@ant-design/icons';\r\nimport LinkButton from '../../../../../components/LinkButton';\r\nimport { updateProduct, fetchProduct } from '../../../../../api/product';\r\nimport { fetchCategory } from '../../../../../api/category';\r\nimport { dataMapToOptions } from '@/utils';\r\nimport { nanoid } from 'nanoid';\r\n\r\nconst formItemLayout = {\r\n  labelCol: {\r\n    xs: {\r\n      span: 4,\r\n    },\r\n    sm: {\r\n      span: 2,\r\n    },\r\n  },\r\n  wrapperCol: {\r\n    xs: {\r\n      span: 18,\r\n    },\r\n    sm: {\r\n      span: 8,\r\n    },\r\n  },\r\n};\r\nconst tailFormItemLayout = {\r\n  wrapperCol: {\r\n    xs: {\r\n      span: 4,\r\n      offset: 0,\r\n    },\r\n    sm: {\r\n      span: 3,\r\n      offset: 0,\r\n    },\r\n  },\r\n};\r\nconst validateValues = (data, sumData) => {\r\n  return !!(sumData.find(v => {\r\n    // 名称不能一样\r\n    if (v.title === data.title) {\r\n      return true;\r\n    } else {\r\n      return false;\r\n    }\r\n  }))\r\n}\r\n\r\nexport default function Update({ sumData, setSumData, setSource }) {\r\n  const [form] = Form.useForm();\r\n  const history = useHistory();\r\n  const { id } = useParams();\r\n  // 分类设置获取\r\n  const [options, setOptions] = useState([]);\r\n  // 图片预览\r\n  const [previewVisible, setPreviewVisible] = useState(false);\r\n  const [previewImage, setPreviewImage] = useState('');\r\n  const [previewTitle, setPreviewTitle] = useState('');\r\n  // 上传图片列表\r\n  const [fileList, setFileList] = useState([]);\r\n  // 图片的访问路径\r\n  const [src, setSrc] = useState('');\r\n  // 对于修改数据获取对应的 id \r\n  let updateItem = null, updateIndex = -1;\r\n  if (id !== 'add') {\r\n    updateIndex = sumData.findIndex(v => v.pid == id);\r\n    if (updateIndex !== -1) {\r\n      updateItem = sumData[updateIndex];\r\n    }\r\n  }\r\n  // 回退方法\r\n  const backToList = () => {\r\n    history.goBack();\r\n  }\r\n  // 表单提交之后回调\r\n  const onFinish = async (values) => {\r\n    console.log(values);\r\n    let res = null;\r\n    if (updateItem) {\r\n      let tem = { ...updateItem };\r\n      tem.title = values.title;\r\n      tem.seller = values.seller;\r\n      tem.price = values.price;\r\n      tem.type = [...values.type];\r\n      tem.src = src;\r\n      try {\r\n        res = await updateProduct(tem);\r\n      } catch (err) {\r\n        console.log(err);\r\n      }\r\n      let res1 = await fetchProduct();\r\n      res1 = res1.map(v => {\r\n        v.key = v.pid;\r\n        return v;\r\n      })\r\n      setSource(res1);\r\n      setSumData(res1);\r\n    } else {\r\n      // 验证values的数据，封装 生成返回给后台的数据格式\r\n      let flag = validateValues(values, sumData);\r\n      if (flag) {\r\n        message.error('重复添加商品名称')\r\n        return;\r\n      }\r\n      // 整理数据格式\r\n      values.pid = nanoid();\r\n      values.key = values.pid;\r\n      values.price = `￥${values.price}`;\r\n      values.src = src;\r\n      // 发送post请求添加数据\r\n      res = await updateProduct(values);\r\n      setSumData([...sumData, values]);\r\n      setSource([...sumData, values]);\r\n    }\r\n    // 收尾工作\r\n    message.success(res);\r\n    history.replace('/product');\r\n  };\r\n\r\n  const uploadButton = (\r\n    <div>\r\n      <PlusOutlined />\r\n      <div style={{ marginTop: 8 }}>Upload</div>\r\n    </div>\r\n  );\r\n  const handleCancel = () => setPreviewVisible(false);\r\n\r\n  const handlePreview = async file => {\r\n    if (!file.url && !file.preview) {\r\n      file.preview = await getBase64(file.originFileObj);\r\n    }\r\n    setPreviewImage(file.url || file.preview);\r\n    setPreviewVisible(true);\r\n    setPreviewTitle(file.name || file.url.substring(file.url.lastIndexOf('/') + 1));\r\n  };\r\n\r\n  const handleChange = ({ file, fileList }) => {\r\n    setFileList(fileList);\r\n    if (file.response) {\r\n      let src = file.response.split('/');\r\n      src.shift();\r\n      setSrc(`/${src.join('/')}`);\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    // 获取最新的分类\r\n    const getOptions = async () => {\r\n      let res = await fetchCategory();\r\n      let target = dataMapToOptions(res, []);\r\n      setOptions(target)\r\n    }\r\n    getOptions();\r\n    // 设置初始值\r\n    if (updateItem) {\r\n      form.setFieldsValue({\r\n        title: updateItem.title,\r\n        seller: updateItem.seller,\r\n        price: updateItem.price,\r\n        type: [updateItem.type],\r\n      });\r\n      updateItem.src = updateItem.src[0] === '/' ? updateItem.src : ('/' + updateItem.src)\r\n      setFileList([{\r\n        uid: -updateIndex,\r\n        name: updateItem.title,\r\n        status: 'done',\r\n        url: 'http://localhost:5000' + updateItem.src\r\n      }])\r\n    }\r\n  }, []);\r\n\r\n  return (\r\n    <Card title=\"\" extra={\r\n      <div className=\"detail-title\">\r\n        <ArrowLeftOutlined />\r\n        <LinkButton\r\n          onClick={backToList}\r\n        >返回商品列表</LinkButton>\r\n      </div>} >\r\n      <Form\r\n        {...formItemLayout}\r\n        form={form}\r\n        name=\"confirm\"\r\n        onFinish={onFinish}\r\n        scrollToFirstError\r\n      >\r\n        <Form.Item\r\n          name=\"title\"\r\n          label=\"商品名称\"\r\n          rules={[\r\n            {\r\n              required: true,\r\n              message: 'Please input your product name!',\r\n            },\r\n          ]}\r\n        >\r\n          <Input />\r\n        </Form.Item>\r\n\r\n        <Form.Item\r\n          name=\"seller\"\r\n          label=\"店铺名称\"\r\n          rules={[\r\n            {\r\n              required: true,\r\n              message: 'Please input your shop name!',\r\n            },\r\n          ]}\r\n        >\r\n          <Input />\r\n        </Form.Item>\r\n\r\n        <Form.Item\r\n          name=\"price\"\r\n          label=\"商品价格\"\r\n          rules={[\r\n            {\r\n              required: true,\r\n              message: 'Please input your product price!',\r\n            },\r\n          ]}\r\n        >\r\n          <Input />\r\n        </Form.Item>\r\n\r\n        <Form.Item\r\n          name=\"type\"\r\n          label=\"商品分类\"\r\n          rules={[\r\n            {\r\n              required: true,\r\n              message: 'Please select your habitual residence!',\r\n            },\r\n          ]}\r\n        >\r\n          <Cascader options={options} placeholder=\"选择商品分类\" />\r\n        </Form.Item>\r\n\r\n        <Form.Item\r\n          label=\"商品图片\"\r\n          name=\"src\"\r\n          valuePropName=\"fileList\"\r\n        >\r\n          <>\r\n            <Upload\r\n              action=\"http://localhost:5000/img/upload\"\r\n              name=\"file\"\r\n              listType=\"picture-card\"\r\n              fileList={fileList}\r\n              onPreview={handlePreview}\r\n              onChange={handleChange}\r\n            >\r\n              {fileList.length >= 1 ? null : uploadButton}\r\n            </Upload>\r\n            <Modal\r\n              visible={previewVisible}\r\n              title={previewTitle}\r\n              footer={null}\r\n              onCancel={handleCancel}\r\n            >\r\n              <img alt=\"example\" style={{ width: '100%' }} src={previewImage} />\r\n            </Modal>\r\n          </>\r\n        </Form.Item>\r\n        <Form.Item {...tailFormItemLayout}>\r\n          <Button type=\"primary\" htmlType=\"submit\">\r\n            确认提交\r\n        </Button>\r\n        </Form.Item>\r\n      </Form>\r\n\r\n    </Card >\r\n  )\r\n}\r\n\r\n\r\nfunction getBase64(file) {\r\n  return new Promise((resolve, reject) => {\r\n    const reader = new FileReader();\r\n    reader.readAsDataURL(file);\r\n    reader.onload = () => resolve(reader.result);\r\n    reader.onerror = error => reject(error);\r\n  });\r\n}\r\n\r\n"],"sourceRoot":""}